{"version":3,"file":"event-bus.umd.js","sources":["../src/eev/RunnableLink.ts","../src/eev/LinkedList.ts","../src/eev/index.ts","../src/inject/js.ts","../src/utils/getMsieVersion.ts","../src/inject/style.ts","../src/print/index.ts","../src/goTop/index.ts","../src/store/index.ts","../src/registerEvents.ts","../src/inject/link.ts","../src/index.ts"],"sourcesContent":["import { CallbackFunction } from './typings';\n\nconst identity = (...args: any[]) => args;\n\nexport default class RunnableLink {\n  prev?: RunnableLink;\n\n  next?: RunnableLink;\n\n  fn: CallbackFunction;\n\n  constructor(prev?: RunnableLink, next?: RunnableLink, fn: CallbackFunction = identity) {\n    this.prev = prev;\n    this.next = next;\n    this.fn = fn;\n  }\n\n  run = (...args: any[]) => {\n    this.fn(...args);\n    if (this.next) this.next.run(...args);\n  };\n}\n","import RunnableLink from './RunnableLink';\nimport { CallbackFunction } from './typings';\n\nexport default class LinkedList {\n  head: RunnableLink;\n\n  tail: RunnableLink;\n\n  reg: {};\n\n  constructor() {\n    this.head = new RunnableLink();\n    this.tail = new RunnableLink(this.head);\n    this.head.next = this.tail;\n    this.reg = {};\n  }\n\n  insert = (fn: CallbackFunction) => {\n    const link = new RunnableLink(this.tail.prev, this.tail, fn);\n    // @ts-ignore\n    // eslint-disable-next-line no-multi-assign\n    link.next.prev = link.prev.next = link;\n    return link;\n  };\n\n  remove = (link: RunnableLink) => {\n    // eslint-disable-next-line no-param-reassign\n    if (link.prev) link.prev.next = link.next;\n    // eslint-disable-next-line no-param-reassign\n    if (link.next) link.next.prev = link.prev;\n  };\n}\n","import { EventKey } from '../typings/EventKey';\nimport LinkedList from './LinkedList';\nimport { CallbackFunction } from './typings';\n\nconst splitter = /[\\s,]+/g;\n\nclass Eev {\n  events: {};\n\n  constructor() {\n    this.events = {};\n  }\n\n  id = 0;\n\n  on = (names: string, fn: CallbackFunction) => {\n    const me = this;\n\n    names.split(splitter).forEach((name: string) => {\n      const list = me.events[name] || (me.events[name] = new LinkedList());\n      // eslint-disable-next-line no-param-reassign\n      const eev = fn._eev || (fn._eev = ++this.id);\n\n      if (!list.reg[eev]) list.reg[eev] = list.insert(fn);\n    });\n  };\n\n  off = (names: string, fn: CallbackFunction) => {\n    if (fn) {\n      names.split(splitter).forEach((name: string) => {\n        const list = this.events[name];\n\n        if (!list) {\n          return;\n        }\n\n        const link = list.reg[fn._eev];\n\n        list.reg[fn._eev] = undefined;\n\n        if (list && link) list.remove(link);\n      });\n    }\n  };\n\n  emit = <T extends string>(name: EventKey | T, ...args: any[]) => {\n    const evt = this.events[name as string];\n    if (evt && evt.head) evt.head.run(...args);\n  };\n}\n\nexport default Eev;\n","export default (url: string, document: Document = window.document) => {\n  const script = document.createElement('script');\n  script.type = 'text/javascript';\n  script.src = url;\n\n  return new Promise((resolve, reject) => {\n    // @ts-ignore\n    if (script.readyState) {\n      // @ts-ignore\n      script.onreadystatechange = function onreadystatechange() {\n        // @ts-ignore\n        if (this.readyState === 'loaded' || this.readyState === 'complete') {\n          resolve(null);\n        }\n      };\n    } else {\n      script.onload = () => resolve(null);\n    }\n\n    script.onerror = () => reject();\n\n    document.head.appendChild(script);\n  });\n};\n","export default function getMsieVersion() {\n  let version = parseInt((/msie (\\d+)/.exec(navigator.userAgent.toLowerCase()) || [])[1], 10);\n\n  // eslint-disable-next-line no-restricted-globals\n  if (isNaN(version)) {\n    version = parseInt(\n      (/trident\\/.*; rv:(\\d+)/.exec(navigator.userAgent.toLowerCase()) || [])[1],\n      10\n    );\n  }\n\n  return version;\n}\n","import getMsieVersion from '../utils/getMsieVersion';\n\ninterface StyleSheet extends CSSStyleSheet {\n  cssText: string;\n  readOnly: boolean;\n}\n\nfunction mergeStyle(css: string, document: Document) {\n  const rulesLength = css.match(/\\{[^{}]*\\}/g)?.length || 0;\n  if (rulesLength === 0) return;\n  let styleSheet: StyleSheet;\n  for (let i = 0; i < document.styleSheets.length; ++i) {\n    styleSheet = document.styleSheets[i] as StyleSheet;\n    if (\n      styleSheet.rules.length + rulesLength <= 3900 &&\n      styleSheet.cssText.indexOf('@import') === -1 &&\n      !styleSheet.disabled &&\n      !styleSheet.readOnly &&\n      (!styleSheet.media || styleSheet.media.length === 0)\n    ) {\n      // @ts-ignore\n      // eslint-disable-next-line no-param-reassign\n      document.styleSheets[i].cssText += css;\n      return true;\n    }\n  }\n  return false;\n}\n\nfunction ieLimit() {\n  return getMsieVersion() < 10 && document.styleSheets.length > 20;\n}\n\nfunction injectCssFn(css: string, document: Document = window.document) {\n  if (ieLimit()) {\n    mergeStyle(css, document);\n    return;\n  }\n\n  const headEl = document.getElementsByTagName('head')[0];\n  const styleEl = document.createElement('style');\n  headEl.appendChild(styleEl);\n\n  try {\n    styleEl.innerHTML = css;\n  } catch (e) {\n    try {\n      styleEl.innerText = css;\n    } catch (error) {\n      // @ts-ignore\n      styleEl.styleSheet.cssText = css;\n    }\n  }\n}\n\nexport default injectCssFn;\n","import getMsieVersion from '../utils/getMsieVersion';\n\nexport default function print() {\n  // ie使用第三方插件(ActiveX)实现打印预览, 需要再index.html中引用\n  // @ts-ignore\n  if (getMsieVersion() && document?.all?.factory?.printing?.Preview) {\n    try {\n      // @ts-ignore\n      document.all.factory.printing.Preview();\n    } catch (e) {\n      window.print();\n    }\n  } else {\n    window.print();\n  }\n}\n","export default (where: number | string = 0, isSmooth: boolean = true) => {\n  const top =\n    typeof where === 'number'\n      ? where\n      : (document.querySelector(where) as HTMLElement)?.offsetTop ?? 0;\n\n  window.scrollTo({\n    top,\n    behavior: isSmooth ? 'smooth' : undefined,\n  });\n};\n","const serialize = (value: any) => JSON.stringify(value);\n\nconst deserialize = (value?: string | null) => {\n  if (typeof value !== 'string') {\n    return undefined;\n  }\n  try {\n    return JSON.parse(value);\n  } catch (e) {\n    return value || undefined;\n  }\n};\n\nexport function set(key: string, val: any) {\n  if (val === undefined) {\n    return localStorage.remove(key);\n  }\n  localStorage.setItem(key, serialize(val));\n  return val;\n}\n\nexport function get(key: string, defaultVal: any) {\n  const val = deserialize(localStorage.getItem(key));\n  return val === undefined ? defaultVal : val;\n}\nexport function remove(key: string) {\n  localStorage.removeItem(key);\n}\n\nexport function clear() {\n  localStorage.clear();\n}\n","import { message, Modal, notification } from 'antd';\nimport injectJs from './inject/js';\nimport injectStyle from './inject/style';\nimport injectLink from './inject/link';\nimport print from './print';\nimport Eev from './eev';\nimport gotop from './goTop';\nimport * as store from './store';\n\nconst injectCss = (data: string, type = 'style') => {\n  if (type === 'style') injectStyle(data, window.document);\n  if (type === 'link') injectLink(data, window.document);\n};\n\nexport default (eventBus: Eev) => {\n  /**\n   * @param {string} data - 被注入的样式数据(css代码 | css文件链接)\n   * @param {string} type - 注入的方式 style | link\n   * injectCss: fn(data, type)\n   */\n  eventBus.on('inject.css', injectCss);\n\n  /**\n   * @param {string} src - 被注入的js文件链接\n   * injectjs: fn(src) => Promise\n   */\n  eventBus.on('inject.js', injectJs);\n\n  /**\n   * store.set: fn(key, value)\n   */\n  eventBus.on('store.set', store.set.bind(store));\n\n  /**\n   * store.get: fn(key, defaultValue)\n   */\n  eventBus.on('store.get', store.get.bind(store));\n\n  /**\n   * store.remove: fn(key)\n   */\n  eventBus.on('store.remove', store.remove.bind(store));\n\n  /**\n   * store.clear: fn()\n   */\n  eventBus.on('store.clear', store.clear.bind(store));\n\n  /**\n   * 回到页面顶部(可以指定位置)\n   * gotop: fn(position=0, isSmooth=true)\n   */\n  eventBus.on('page.gotop', gotop);\n\n  /**\n   * 页面打印, ie尝试使用打印插件\n   */\n  eventBus.on('page.print', print);\n\n  /**\n   * antd 的 Modal, 如何使用参见:\n   * https://ant.design/components/modal-cn/#Modal.method()\n   */\n  eventBus.on('antd.Modal.info', Modal.info);\n  eventBus.on('antd.Modal.success', Modal.success);\n  eventBus.on('antd.Modal.error', Modal.error);\n  eventBus.on('antd.Modal.warning', Modal.warning);\n  eventBus.on('antd.Modal.confirm', Modal.confirm);\n  eventBus.on('antd.Modal.destroyAll', Modal.destroyAll);\n\n  /**\n   * antd 的 message, 如何使用参见:\n   * https://ant.design/components/message-cn/#API\n   */\n  eventBus.on('antd.message.info', message.info);\n  eventBus.on('antd.message.success', message.success);\n  eventBus.on('antd.message.error', message.error);\n  eventBus.on('antd.message.warning', message.warning);\n  eventBus.on('antd.message.loading', message.loading);\n  eventBus.on('antd.message.destroy', message.destroy);\n\n  /**\n   * antd 的 message, 如何使用参见:\n   * https://ant.design/components/notification-cn/#API\n   */\n  eventBus.on('antd.notification.info', notification.info);\n  eventBus.on('antd.notification.success', notification.success);\n  eventBus.on('antd.notification.error', notification.error);\n  eventBus.on('antd.notification.warning', notification.warning);\n  eventBus.on('antd.notification.open', notification.open);\n  eventBus.on('antd.notification.close', notification.close);\n  eventBus.on('antd.notification.destroy', notification.destroy);\n};\n","export default (linkHref: string, document: Document = window.document) => {\n  const head = document.querySelector('head');\n  const linkTag = document.createElement('link');\n\n  linkTag.href = linkHref;\n  linkTag.setAttribute('rel', 'stylesheet');\n  linkTag.setAttribute('type', 'text/css');\n\n  if (head) head.appendChild(linkTag);\n};\n","/* eslint-disable no-restricted-globals */\nimport Eev from './eev';\nimport registerEvents from './registerEvents';\n\nconst create = (registerDefaultEvents: boolean) => {\n  const eventBus = new Eev();\n  if (registerDefaultEvents) registerEvents(eventBus);\n  return eventBus;\n};\n\n/**\n * 创建或者从顶层窗口查找 eventBus\n * @param forceCreateNew 强制使用新的 eventBus, 否则尝试查找 top.eventBus\n * @param registerDefaultEvents 注册默认事件\n */\nconst createOrFindInTop = (\n  forceCreateNew: boolean = false,\n  registerDefaultEvents: boolean = true\n): Eev => {\n  try {\n    if (forceCreateNew) {\n      return create(registerDefaultEvents);\n    }\n\n    // @ts-ignore\n    if (top.eventBus) {\n      // @ts-ignore\n      return top.eventBus;\n    }\n\n    const eventBus = create(registerDefaultEvents);\n    /**\n     * 在子页面中创建的 eventBus, 不赋值到 top\n     * 不然可能会把 top.eventBus 意外覆盖掉\n     */\n    // @ts-ignore\n    if (top === self) top.eventBus = eventBus;\n    return eventBus;\n  } catch (e) {\n    return create(registerDefaultEvents);\n  }\n};\n\nexport default createOrFindInTop;\n"],"names":["identity","_i","args","prev","next","fn","this","_this","_a","run","link","RunnableLink","tail","head","reg","splitter","names","me","split","forEach","name","list","events","LinkedList","eev","_eev","id","insert","undefined","remove","evt","url","document","window","script","createElement","type","src","Promise","resolve","reject","readyState","onreadystatechange","onload","onerror","appendChild","getMsieVersion","version","parseInt","exec","navigator","userAgent","toLowerCase","isNaN","ieLimit","styleSheets","length","print","all","factory","printing","Preview","e","where","isSmooth","top","querySelector","offsetTop","scrollTo","behavior","set","key","val","localStorage","setItem","JSON","stringify","get","defaultVal","value","parse","deserialize","getItem","removeItem","clear","injectCss","data","css","rulesLength","match","styleSheet","i","rules","cssText","indexOf","disabled","readOnly","media","mergeStyle","headEl","getElementsByTagName","styleEl","innerHTML","innerText","error","injectStyle","linkHref","linkTag","href","setAttribute","injectLink","create","registerDefaultEvents","eventBus","Eev","on","injectJs","store.set","bind","store","store.get","store.remove","store.clear","gotop","Modal","info","success","warning","confirm","destroyAll","message","loading","destroy","notification","open","close","registerEvents","forceCreateNew","self"],"mappings":"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"}